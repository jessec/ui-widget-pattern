pmrpc=self.pmrpc=function(){function F(){for(var a=[],b=0;36>b;b++)a[b]="0123456789ABCDEF"[Math.floor(16*Math.random())];a[14]="4";a[19]="89AB"[Math.floor(4*Math.random())];a[8]=a[13]=a[18]=a[23]="-";return a.join("")}function G(a,b){for(var c=a.whitelist,d=a.blacklist,g=!1,e=!1,h=0;h<c.length;++h)if(b.match(new RegExp(c[h]))){g=!0;break}for(c=0;c<d.length;++c)if(b.match(new RegExp(d[c]))){e=!0;break}return g&&!e}function y(a,b,c,d){if(!(c instanceof Array)){for(var g=a.toString(),e=g.substring(g.indexOf("(")+
1,g.indexOf(")")),e=""===e?[]:e.split(", "),g={},h=0;h<e.length;h++)g[e[h]]=h;var e=[],p;for(p in c)if("undefined"!==typeof g[p])e[g[p]]=c[p];else throw"No such param: "+p;c=e}"undefined"!==typeof d&&(c=c.concat(d));return a.apply(b,c)}function z(a,b,c){var d={jsonrpc:"2.0"};d.method=a;d.params=b;"undefined"!==typeof c&&(d.id=c);return d}function l(a,b,c){var d={};d.code=a;d.message=b;d.data=c;return d}function k(a,b,c){var d={jsonrpc:"2.0"};d.id=c;"undefined"===typeof a||null===a?d.result="undefined"===
b?null:b:d.error=a;return d}function w(a){if(a.publicProcedureName in s)return!1;m[a.publicProcedureName]={publicProcedureName:a.publicProcedureName,procedure:a.procedure,context:a.procedure.context,isAsync:"undefined"!==typeof a.isAsynchronous?a.isAsynchronous:!1,acl:"undefined"!==typeof a.acl?a.acl:{whitelist:["(.*)"],blacklist:[]}};return!0}function q(a){var b=a.event,c=a.source,d="undefined"!==typeof c&&null!==c;0===b.data.indexOf("pmrpc.")&&(a=JSON.parse(b.data.substring(6)),"undefined"!==typeof a.method?
(b={data:b.data,source:d?c:b.source,origin:d?"*":b.origin,shouldCheckACL:!d},a=H(a,b),null!==a&&t(b.source,a,b.origin)):A(a))}function H(a,b,c){if("2.0"!==a.jsonrpc)return k(l(-32600,"Invalid request.","The recived JSON is not a valid JSON-RPC 2.0 request."),null,null);var d=a.id;c=m[a.method];if("undefined"!==typeof c)if(!b.shouldCheckACL||G(c.acl,b.origin))try{if(c.isAsync)return y(c.procedure,c.context,a.params,[function(a){t(b.source,k(null,a,d),b.origin)},function(a){t(b.source,k(l(-1,"Application error.",
a.message),null,d),b.origin)},b]),null;var g=y(c.procedure,c.context,a.params,[b]);return"undefined"===typeof d?null:k(null,g,d)}catch(e){return"undefined"===typeof d?null:e.match("^(No such param)")?k(l(-32602,"Invalid params.",e.message),null,d):k(l(-1,"Application error.",e.message),null,d)}else return"undefined"===typeof d?null:k(l(-2,"Application error.","Access denied on server."),null,d);else return"undefined"===typeof d?null:k(l(-32601,"Method not found.","The requestd remote procedure does not exist or is not available."),
null,d)}function A(a){var b=a.id,c=f[b];if("undefined"!==typeof c&&null!==c)if(delete f[b],"undefined"===typeof a.error)c.onSuccess({destination:c.destination,publicProcedureName:c.publicProcedureName,params:c.params,status:"success",returnValue:a.result});else c.onError({destination:c.destination,publicProcedureName:c.publicProcedureName,params:c.params,status:"error",message:a.error.message+" "+a.error.data})}function B(a){if(a.retries&&0>a.retries)throw new Exception("number of retries must be 0 or higher");
var b=[];if("undefined"===typeof a.destination||null===a.destination||"workerParent"===a.destination)b=[{context:null,type:"workerParent"}];else if("publish"===a.destination)b=C().concat(u);else if(a.destination instanceof Array)for(var c=0;c<a.destination.length;c++)"workerParent"===a.destination[c]?b.push({context:null,type:"workerParent"}):"undefined"!==typeof a.destination[c].frames?b.push({context:a.destination[c],type:"window"}):b.push({context:a.destination[c],type:"worker"});else"undefined"!==
typeof a.destination.frames?b.push({context:a.destination,type:"window"}):b.push({context:a.destination,type:"worker"});for(c=0;c<b.length;c++){var d={destination:b[c].context,destinationDomain:"undefined"===typeof a.destinationDomain?["*"]:"string"===typeof a.destinationDomain?[a.destinationDomain]:a.destinationDomain,publicProcedureName:a.publicProcedureName,onSuccess:"undefined"!==typeof a.onSuccess?a.onSuccess:function(){},onError:"undefined"!==typeof a.onError?a.onError:function(){},retries:"undefined"!==
typeof a.retries?a.retries:5,timeout:"undefined"!==typeof a.timeout?a.timeout:500,status:"requestNotSent"};isNotification="undefined"===typeof a.onError&&"undefined"===typeof a.onSuccess;params="undefined"!==typeof a.params?a.params:[];callId=F();f[callId]=d;d.message=isNotification?z(a.publicProcedureName,params):z(a.publicProcedureName,params,callId);v(callId)}}function t(a,b,c){if("undefined"===typeof a||null===a)self.postMessage("pmrpc."+JSON.stringify(b));else{if("undefined"!==typeof a.frames)return a.postMessage("pmrpc."+
JSON.stringify(b),c);a.postMessage("pmrpc."+JSON.stringify(b))}}function v(a){var b=f[a];if("undefined"!==typeof b)if(-1>=b.retries)A(k(l(-4,"Application error.","Destination unavailable."),null,a));else if("requestSent"!==b.status)if(0===b.retries||"available"===b.status){b.status="requestSent";b.retries=-1;f[a]=b;for(var c=0;c<b.destinationDomain.length;c++)t(b.destination,b.message,b.destinationDomain[c],b),self.setTimeout(function(){v(a)},b.timeout)}else b.status="pinging",c=b.retries,b.retries=
c-1,B({destination:b.destination,publicProcedureName:"receivePingRequest",onSuccess:function(b){!0===b.returnValue&&"undefined"!==typeof f[a]&&(f[a].status="available",v(a))},params:[b.publicProcedureName],retries:0,destinationDomain:b.destinationDomain}),f[a]=b,self.setTimeout(function(){f[a]&&"pinging"===f[a].status&&v(a)},b.timeout/c)}function n(a,b,c,d){"addEventListener"in a?a.addEventListener(b,c,d):a.attachEvent("on"+b,c)}function r(a,b,c){return function(d){a({event:d,source:b,destinationType:c})}}
function C(){var a=[];if("undefined"!==typeof window){a.push({context:window.top,type:"window"});for(var b=0;"undefined"!==typeof a[b];b++)for(var c=a[b],d=0;d<c.context.frames.length;d++)a.push({context:c.context.frames[d],type:"window"})}else a.push({context:this,type:"workerParent"});return a}if("undefined"===typeof JSON||"undefined"===typeof JSON.stringify||"undefined"===typeof JSON.parse)throw"pmrpc requires the JSON library";if("undefined"===typeof this.postMessage&&"undefined"===typeof this.onconnect)throw"pmrpc requires the HTML5 cross-document messaging and worker APIs";
var m={},f={},s={};if("window"in this){var x=r(q,null,"window");n(this,"message",x,!1)}else if("onmessage"in this)x=r(q,this,"worker"),n(this,"message",x,!1);else if("onconnect"in this)n(this,"connect",function(a){var b=r(q,a.ports[0],"sharedWorker");n(a.ports[0],"message",b,!1);a.ports[0].start()},!1);else throw"Pmrpc must be loaded within a browser window or web worker.";var D=this.Worker;this.nonPmrpcWorker=D;var E=this.SharedWorker;this.nonPmrpcSharedWorker=E;var u=[];this.Worker=function(a){a=
new D(a);u.push({context:a,type:"worker"});var b=r(q,a,"worker");n(a,"message",b,!1);return a};this.SharedWorker=function(a,b){var c=new E(a,b);u.push({context:c,type:"sharedWorker"});var d=r(q,c.port,"sharedWorker");n(c.port,"message",d,!1);c.postMessage=function(a,b){return c.port.postMessage(a,b)};c.port.start();return c};w({publicProcedureName:"receivePingRequest",procedure:function(a){return"undefined"!==typeof m[a]}});w({publicProcedureName:"getRegisteredProcedures",procedure:function(){var a=
[],b="undefined"!==typeof this.frames?window.location.protocol+"//"+window.location.host+(""!==window.location.port?":"+window.location.port:""):"",c;for(c in m)c in s||a.push({publicProcedureName:m[c].publicProcedureName,acl:m[c].acl,origin:b});return a}});s={getRegisteredProcedures:null,receivePingRequest:null};return{register:w,unregister:function(a){if(a in s)return!1;delete m[a];return!0},call:B,discover:function(a){var b=null;if("undefined"===typeof a.destination)for(var b=C().concat(u),c=0;c<
b.length;c++)b[c]=b[c].context;else b=a.destination;var d="undefined"===typeof a.originRegex?"(.*)":a.originRegex,g="undefined"===typeof a.nameRegex?"(.*)":a.nameRegex,e=b.length,h=[];pmrpc.call({destination:b,destinationDomain:"*",publicProcedureName:"getRegisteredProcedures",onSuccess:function(b){e--;var c=b.returnValue;b=b.destination;for(var f=0;f<c.length;f++)c[f].origin.match(new RegExp(d))&&c[f].publicProcedureName.match(new RegExp(g))&&h.push({publicProcedureName:c[f].publicProcedureName,
destination:b,procedureACL:c[f].acl,destinationOrigin:c[f].origin});0===e&&a.callback(h)},onError:function(b){e--;0===e&&a.callback(h)}})}}}();"function"==typeof define&&define.amd&&define(pmrpc);